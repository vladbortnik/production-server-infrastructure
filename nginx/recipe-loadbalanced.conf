# Load-Balanced Nginx Configuration for Multi-Instance Flask Application
# This configuration distributes traffic across multiple backend servers for high availability

# Upstream Block - Load Balancer Configuration
upstream recipe_app {
    # ip_hash ensures the same client IP always connects to the same backend server
    # This is crucial for session persistence (sticky sessions)
    ip_hash;

    # Backend servers with health check configuration
    # max_fails: Number of failed connection attempts before marking server as unavailable
    # fail_timeout: Time to wait before retrying a failed server
    server 127.0.0.1:5002 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:5003 max_fails=3 fail_timeout=30s;     # Ports must match docker-compose.yml
    server 127.0.0.1:5004 max_fails=3 fail_timeout=30s;
}

# Optional: Detailed logging for monitoring load balancer performance
# Uncomment these lines to track upstream server response times and connection details
# log_format upstream_time '$remote_addr - $remote_user [$time_local] '
#                        '"$request" $status $body_bytes_sent '
#                        '"$http_referer" "$http_user_agent" '
#                        'rt=$request_time uct="$upstream_connect_time" uht="$upstream_header_time" urt="$upstream_response_time" '
#                        'upstream_addr="$upstream_addr"';

# HTTP Server Block - Redirects all HTTP traffic to HTTPS
server {
    listen 80;
    # listen [::]:80;    # Uncomment for IPv6 support

    server_name your-app.your-domain.com;

    # Optional: Enable detailed logging
    # access_log /var/log/nginx/access.log upstream_time;
    # error_log /var/log/nginx/error.log debug;

    location / {
        return 301 https://$host$request_uri;   # Redirect all HTTP requests to HTTPS
    }
}

# HTTPS Server Block - Main application server with load balancing
server {
    listen 443 ssl http2;
    # listen [::]:443 ssl http2;     # Uncomment for IPv6 support

    # Optional: Enable detailed logging
    # access_log /var/log/nginx/access.log upstream_time;
    # error_log /var/log/nginx/error.log debug;

    # SSL/TLS Certificate Configuration
    # Update these paths to point to your Let's Encrypt certificates
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    ssl_session_timeout 1d;
    ssl_session_cache shared:MozSSL:10m;  # About 40000 sessions
    ssl_session_tickets off;

    # Modern TLS Configuration (TLS 1.3 only - maximum security)
    ssl_protocols TLSv1.3;
    ssl_prefer_server_ciphers off;

    # HSTS (HTTP Strict Transport Security)
    # Forces browsers to always use HTTPS for your domain
    add_header Strict-Transport-Security "max-age=63072000" always;

    # Security Headers
    add_header X-Frame-Options "SAMEORIGIN" always;                    # Prevents clickjacking attacks
    add_header X-Content-Type-Options "nosniff" always;                # Prevents MIME-type sniffing
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=()" always;

    # Content Security Policy (CSP) - Customize based on your application needs
    add_header Content-Security-Policy "default-src 'self' data:; img-src 'self' data: blob:; font-src 'self' data:;" always;

    # OCSP Stapling (Optional - improves SSL/TLS handshake performance)
    # ssl_stapling on;
    # ssl_stapling_verify on;
    ssl_trusted_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;

    # DNS Resolver - Replace with your server's DNS resolver IP
    # Common values: 8.8.8.8 (Google), 1.1.1.1 (Cloudflare), or your hosting provider's DNS
    resolver 8.8.8.8;

    server_name your-app.your-domain.com;

    # Document root (optional - needed for serving static files directly)
    root /var/www/your-app.your-domain.com/html;

    # Reverse Proxy Configuration with Load Balancing
    location / {
        # Forward requests to the upstream group (load balancer)
        proxy_pass http://recipe_app;           # Uses the upstream block defined above

        # For testing a single backend server, comment out the line above and uncomment below:
        # proxy_pass http://127.0.0.1:5002;

        # Proxy headers - pass client information to backend servers
        proxy_set_header Host $host;                               # Preserves original host header
        proxy_set_header X-Real-IP $remote_addr;                   # Passes client IP to backend
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # Proxy chain information
        proxy_set_header X-Forwarded-Proto $scheme;                # Original protocol (http/https)
    }
}
