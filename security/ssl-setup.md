# SSL/TLS Setup with Let's Encrypt

Complete guide for configuring SSL/TLS certificates using Let's Encrypt (Certbot) to achieve A+ rating on SSL Labs.

## Overview

This setup provides:
- **A+ SSL Labs Rating** ✅
- **TLS 1.2 and 1.3** support
- **Perfect Forward Secrecy**
- **OCSP Stapling**
- **Automatic certificate renewal**

## Prerequisites

- Ubuntu 24.04 LTS server
- Domain name with DNS configured
- Nginx installed and running
- Ports 80 and 443 open in firewall

## Installation

### 1. Install Certbot

```bash
# Update package list
sudo apt update

# Install Certbot and Nginx plugin
sudo apt install certbot python3-certbot-nginx -y

# Verify installation
certbot --version
```

### 2. Prepare Nginx Configuration

Before obtaining certificates, ensure your Nginx server blocks are configured:

```bash
# Test Nginx configuration
sudo nginx -t

# Reload Nginx if test passes
sudo systemctl reload nginx
```

## Certificate Generation

### Generate Certificates for Main Domain

```bash
# For main domain and www subdomain
sudo certbot --nginx -d vladbortnik.dev -d www.vladbortnik.dev
```

**Certbot will:**
1. Verify domain ownership via HTTP-01 challenge
2. Generate SSL certificates
3. Automatically update Nginx configuration
4. Set up auto-renewal

**Interactive prompts:**
- Email address: Enter your email for renewal notifications
- Terms of Service: Agree to Let's Encrypt TOS
- HTTPS redirect: Choose option 2 (redirect all HTTP to HTTPS)

### Generate Certificates for Subdomains

```bash
# Recipe subdomain
sudo certbot --nginx -d recipe.vladbortnik.dev

# BookFinder subdomain
sudo certbot --nginx -d bookfinder.vladbortnik.dev
```

### Generate Multiple Certificates at Once

```bash
sudo certbot --nginx \
  -d vladbortnik.dev \
  -d www.vladbortnik.dev \
  -d recipe.vladbortnik.dev \
  -d bookfinder.vladbortnik.dev
```

## SSL Configuration

### Nginx SSL Settings (A+ Rating)

Certbot automatically adds basic SSL settings, but for A+ rating, enhance them:

```nginx
# SSL Certificate paths (auto-generated by Certbot)
ssl_certificate /etc/letsencrypt/live/vladbortnik.dev/fullchain.pem;
ssl_certificate_key /etc/letsencrypt/live/vladbortnik.dev/privkey.pem;

# SSL Protocols (only TLS 1.2 and 1.3)
ssl_protocols TLSv1.2 TLSv1.3;

# SSL Ciphers (strong ciphers only, with PFS)
ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-CHACHA20-POLY1305;
ssl_prefer_server_ciphers off;

# OCSP Stapling (improves SSL handshake performance)
ssl_stapling on;
ssl_stapling_verify on;
ssl_trusted_certificate /etc/letsencrypt/live/vladbortnik.dev/chain.pem;

# HSTS (HTTP Strict Transport Security)
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
```

### Create SSL Snippet (Optional)

For easier maintenance across multiple server blocks:

```bash
sudo nano /etc/nginx/snippets/ssl-params.conf
```

**Content:**
```nginx
ssl_protocols TLSv1.2 TLSv1.3;
ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-CHACHA20-POLY1305;
ssl_prefer_server_ciphers off;

ssl_session_cache shared:SSL:10m;
ssl_session_timeout 10m;
ssl_session_tickets off;

ssl_stapling on;
ssl_stapling_verify on;

resolver 8.8.8.8 8.8.4.4 valid=300s;
resolver_timeout 5s;
```

**Include in server blocks:**
```nginx
include snippets/ssl-params.conf;
```

## Certificate Management

### View Certificate Information

```bash
# List all certificates
sudo certbot certificates

# Output shows:
# - Certificate name
# - Domains covered
# - Expiry date
# - Certificate path
# - Key path
```

### Check Certificate Expiration

```bash
# Using Certbot
sudo certbot certificates

# Using OpenSSL
echo | openssl s_client -servername vladbortnik.dev -connect vladbortnik.dev:443 2>/dev/null | openssl x509 -noout -dates
```

### Renew Certificates Manually

```bash
# Dry run (test renewal without actually renewing)
sudo certbot renew --dry-run

# Force renewal (if needed before expiry)
sudo certbot renew --force-renewal

# Renew specific certificate
sudo certbot renew --cert-name vladbortnik.dev
```

## Automatic Renewal

### Verify Auto-Renewal Setup

Certbot automatically creates a systemd timer for renewal:

```bash
# Check timer status
sudo systemctl status certbot.timer

# View timer details
sudo systemctl list-timers | grep certbot
```

**Expected output:**
```
● certbot.timer - Run certbot twice daily
     Loaded: loaded
     Active: active (waiting)
```

### Test Auto-Renewal

```bash
# Simulate renewal process
sudo certbot renew --dry-run
```

### Manual Timer Management

```bash
# Enable timer (already enabled by default)
sudo systemctl enable certbot.timer

# Start timer
sudo systemctl start certbot.timer

# Restart timer
sudo systemctl restart certbot.timer
```

### Renewal Hooks (Post-Renewal Actions)

Create a post-renewal hook to reload Nginx after renewal:

```bash
sudo nano /etc/letsencrypt/renewal-hooks/post/nginx-reload.sh
```

**Content:**
```bash
#!/bin/bash
systemctl reload nginx
```

**Make executable:**
```bash
sudo chmod +x /etc/letsencrypt/renewal-hooks/post/nginx-reload.sh
```

## Certificate Files Structure

```
/etc/letsencrypt/
├── live/
│   └── vladbortnik.dev/
│       ├── fullchain.pem    → Full certificate chain (use in ssl_certificate)
│       ├── privkey.pem      → Private key (use in ssl_certificate_key)
│       ├── cert.pem         → Server certificate only
│       └── chain.pem        → Intermediate certificates (use in ssl_trusted_certificate)
├── archive/
│   └── vladbortnik.dev/     → Actual certificate files (live/ contains symlinks)
├── renewal/
│   └── vladbortnik.dev.conf → Renewal configuration
└── renewal-hooks/
    ├── pre/                 → Scripts run before renewal
    ├── post/                → Scripts run after renewal
    └── deploy/              → Scripts run after successful renewal
```

## Security Best Practices

### 1. Strong Cipher Suite Configuration

Only use strong ciphers with Perfect Forward Secrecy (PFS):

```nginx
ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-CHACHA20-POLY1305;
```

### 2. Disable Weak Protocols

Never use SSL 2.0, SSL 3.0, TLS 1.0, or TLS 1.1:

```nginx
ssl_protocols TLSv1.2 TLSv1.3;
```

### 3. Enable HSTS

Force browsers to use HTTPS:

```nginx
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
```

### 4. OCSP Stapling

Improves SSL handshake performance and privacy:

```nginx
ssl_stapling on;
ssl_stapling_verify on;
ssl_trusted_certificate /etc/letsencrypt/live/vladbortnik.dev/chain.pem;
```

### 5. Secure Key Permissions

```bash
# Verify private key permissions
ls -la /etc/letsencrypt/live/vladbortnik.dev/privkey.pem

# Should be readable only by root
sudo chmod 600 /etc/letsencrypt/archive/vladbortnik.dev/privkey*.pem
```

## Testing SSL Configuration

### 1. SSL Labs Test (Recommended)

Visit: https://www.ssllabs.com/ssltest/analyze.html?d=vladbortnik.dev

**Expected Rating:** A+

**Key Metrics:**
- Certificate: 100%
- Protocol Support: 100%
- Key Exchange: 90%
- Cipher Strength: 90%

### 2. Mozilla Observatory

Visit: https://observatory.mozilla.org/

**Expected Rating:** A+

### 3. Local Testing with OpenSSL

```bash
# Test SSL connection
openssl s_client -connect vladbortnik.dev:443 -servername vladbortnik.dev

# Check supported protocols
nmap --script ssl-enum-ciphers -p 443 vladbortnik.dev

# Test OCSP stapling
echo QUIT | openssl s_client -connect vladbortnik.dev:443 -status 2>/dev/null | grep -A 17 'OCSP response:'
```

### 4. Using testssl.sh

```bash
# Download testssl.sh
git clone https://github.com/drwetter/testssl.sh.git
cd testssl.sh

# Run comprehensive SSL test
./testssl.sh vladbortnik.dev
```

## Troubleshooting

### Certificate Generation Fails

**DNS not configured:**
```bash
# Verify DNS is pointing to your server
dig vladbortnik.dev
nslookup vladbortnik.dev
```

**Port 80 blocked:**
```bash
# Check if Nginx is listening on port 80
sudo netstat -tulpn | grep :80

# Check firewall
sudo ufw status
```

**Nginx not running:**
```bash
sudo systemctl status nginx
sudo systemctl start nginx
```

### Renewal Fails

**Check renewal logs:**
```bash
sudo tail -f /var/log/letsencrypt/letsencrypt.log
```

**Common issues:**
- Firewall blocking port 80
- Nginx misconfiguration
- Domain DNS changed
- Webroot path changed

**Fix and retry:**
```bash
sudo certbot renew --force-renewal
```

### OCSP Stapling Not Working

**Test OCSP stapling:**
```bash
echo QUIT | openssl s_client -connect vladbortnik.dev:443 -status 2>/dev/null | grep 'OCSP Response Status'
```

**Should show:**
```
OCSP Response Status: successful (0x0)
```

**Fix:**
```nginx
# Add resolver to Nginx configuration
resolver 8.8.8.8 8.8.4.4 valid=300s;
resolver_timeout 5s;

ssl_stapling on;
ssl_stapling_verify on;
```

### Mixed Content Warnings

All resources must be loaded over HTTPS:

```html
<!-- Bad: HTTP resources -->
<script src="http://example.com/script.js"></script>

<!-- Good: HTTPS or protocol-relative -->
<script src="https://example.com/script.js"></script>
<script src="//example.com/script.js"></script>
```

## Certificate Revocation

If your private key is compromised:

```bash
# Revoke certificate
sudo certbot revoke --cert-path /etc/letsencrypt/live/vladbortnik.dev/cert.pem

# Generate new certificate
sudo certbot --nginx -d vladbortnik.dev -d www.vladbortnik.dev
```

## Monitoring and Maintenance

### 1. Monitor Certificate Expiration

Set up monitoring alerts 30 days before expiration:

```bash
# Add to crontab
sudo crontab -e
```

**Add:**
```bash
0 0 * * * certbot renew --quiet --post-hook "systemctl reload nginx"
```

### 2. Log Monitoring

```bash
# Watch renewal attempts
sudo tail -f /var/log/letsencrypt/letsencrypt.log

# Check Nginx SSL errors
sudo tail -f /var/log/nginx/error.log | grep SSL
```

### 3. Regular Testing

Schedule monthly SSL tests:
- SSL Labs scan
- Mozilla Observatory scan
- Internal testssl.sh scan

## Additional Resources

- [Let's Encrypt Documentation](https://letsencrypt.org/docs/)
- [Certbot Documentation](https://eff-certbot.readthedocs.io/)
- [SSL Labs Best Practices](https://github.com/ssllabs/research/wiki/SSL-and-TLS-Deployment-Best-Practices)
- [Mozilla SSL Configuration Generator](https://ssl-config.mozilla.org/)
- [Nginx SSL Module Documentation](https://nginx.org/en/docs/http/ngx_http_ssl_module.html)
