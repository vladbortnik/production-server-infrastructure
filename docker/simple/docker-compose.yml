# Simple Docker Compose Configuration for Single Instance Flask Application
# This setup includes: web application, database, and automatic migrations

services:
  # Web Application Service
  web:
    build: .
    # Gunicorn command: 4 worker processes, bind to all interfaces on port 5002
    command: gunicorn -w 4 -b 0.0.0.0:5002 run:app
    volumes:
      - .:/code                          # Mount current directory for development
    ports:
      - "5002:5002"                      # Expose port 5002 to host
    env_file:
      - .env                             # Load environment variables from .env file
    depends_on:
      - db                               # Wait for database to start
      - migration                        # Wait for migrations to complete
    restart: unless-stopped              # Auto-restart unless manually stopped

  # Database Migration Service
  # Runs once to initialize and apply database migrations
  migration:
    build: .
    command: ./scripts/wait-for-migrations.sh  # Script handles DB readiness and migrations
    volumes:
      - .:/code
    env_file:
      - .env
    depends_on:
      - db                               # Wait for database to start first
    restart: "no"                        # Run once and exit

  # PostgreSQL Database Service
  db:
    image: postgres:16.4                 # Use PostgreSQL 16.4
    volumes:
      - postgres_data:/var/lib/postgresql/data  # Persistent storage for database
    env_file:
      - .env                             # Contains DB credentials (POSTGRES_USER, POSTGRES_PASSWORD, etc.)
    ports:
      - "5432:5432"                      # Expose PostgreSQL port to host (⚠️ Consider security implications)
    restart: unless-stopped

# Named volumes for data persistence
volumes:
  postgres_data:                         # PostgreSQL data persists across container restarts
