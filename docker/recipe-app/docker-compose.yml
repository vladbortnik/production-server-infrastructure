# Docker Compose Configuration for Recipe Web Application
# Flask/Gunicorn + PostgreSQL with Network Segregation

version: '3.8'

# Network Segregation
# - frontend: Public-facing network for web service
# - backend: Private, internal network for database access only
networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge

services:
  # Web Service (Flask + Gunicorn)
  web:
    build: .
    container_name: recipe_web
    command: gunicorn -w 4 -b 0.0.0.0:5002 run:app
    volumes:
      - ./code:/code
    networks:
      - frontend  # For communication with Internet (via Nginx)
      - backend   # For communication with DB only
    ports:
      - "5002:5002"  # The only necessary external port
    env_file:
      - .env
    depends_on:
      - db

    # Docker Container Resource Limits
    mem_limit: 384m
    mem_reservation: 192m  # Guaranteed memory
    cpus: 0.3

    restart: unless-stopped

  # Database Service (PostgreSQL)
  db:
    image: postgres:16.4
    container_name: recipe_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    env_file:
      - .env
    networks:
      - backend  # Only Web Service has access to DB

    # Database port is NOT exposed to the host (isolated from Internet)
    # This is a security best practice - only the web service can access the database
    # ports:
    #   - "5432:5432"  # Port is not exposed to host (Isolated from Internet)

    # Docker Container Resource Limits
    mem_limit: 384m
    mem_reservation: 192m
    cpus: 0.3

    restart: unless-stopped

# Docker Named Volume for Database Persistence
volumes:
  postgres_data:
    driver: local
